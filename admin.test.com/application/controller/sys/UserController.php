<?php/*------------ * 用户管理(管理员) *-----------*/use application\module\userModule;use application\module\UserGroupModule;use application\module\MenuModule;use application\ext\Response;use application\ext\Common;class UserController extends Controller{	private $userGroupModule;	public function __construct(){		parent::__construct();		$this->module = new UserModule();		$this->userGroupModule = new UserGroupModule();	}	//用户管理	public function index(){		$user = $this->module->getUser();		$groups = $this->userGroupModule->getUserGroups();		$this->assign('user',$user);		$this->assign('groups',$groups);	}	//添加用户	public function userAdd(){		if($this->post){			if( $this->post['password'] != $this->post['repassword'] ){				Response::response(10203);			}			$password = md5($this->post['password']);			$data['uname'] = $this->post['uname'];			$data['password'] = $password;			$data['groupid'] = $this->post['groupid'];			$data['status'] = $this->post['status'];			$data['addtime'] = date('Y-m-d H:i:s');			if( $this->module->addUser($data) ){				Response::response(Response::SUCCESS);			}			Response::response(Response::FAIL);		}else{			if( $groups = $this->userGroupModule->getUserGroups() ){				$this->assign('groups',$groups);			}		}	}	//编辑用户	public function userEdit(){		if($this->post){			if( !$this->post['uname'] || !$this->post['password'] ){				Response::response(10200);			}			if( $this->post['password'] != $this->post['repassword'] ){				Response::response(10203);			}			$password = md5($this->post['password']);			$data['uname'] = $this->post['uname'];			$data['password'] = $password;			$data['groupid'] = $this->post['groupid'];			$data['status'] = $this->post['status'];			if( $this->module->editUser($data, $this->post['id']) ){				Response::response( Response::SUCCESS );			}else{				Response::response( Response::FAIL );			}		}else if($this->get['id']){			$user = $this->module->getUserById($this->get['id']);			$groups = $this->userGroupModule->getUserGroups();			if($user && $groups){				$this->assign('user',$user);				$this->assign('groups',$groups);			}else{				Response::response( 10201 );			}		}	}	//删除用户	public function userDel(){		if($this->post['id']){			foreach ($this->post['id'] as $val){				if($val == 1){					Response::response( 10202 );				}			}			if($this->module->delUser($this->post['id'])){				Response::response( Response::SUCCESS );			}		}else if($this->get['id']){			if($this->get['id'] == 1){				Response::response( 10202 );			}			if($this->module->delUser($this->get['id'])){				Response::response( Response::SUCCESS );			}		}		Response::response( Response::FAIL );	}	//修改用户密码	public function user_modPwd(){		if($this->post){			if($this->post['new_password'] !== $this->post['re_password']){				Response::response( 10203 );			}			$row = $this->module->getUserById($_SESSION['uid']);			if(md5($this->post['old_password']) !== $row['password']){				Response::response( 10204 );			}			$data['password'] = md5($this->post['new_password']);			if($this->module->editUser($data, $_SESSION['uid'])){				Response::response( Response::SUCCESS );			}			Response::response( Response::FAIL );		}else{			$this->assign('uname',$_SESSION['uname']);		}	}	//用户权限列表	public function authList(){		if( empty($this->get['id']) ){			Response::response( Response::ERROR );		}		$MenuModule = new MenuModule();		$userGrants = $this->module->getUserGrants($this->get['id']);//用户权限		$authMenu = $MenuModule->getAuthMenu($userGrants);		$this->assign('id',$this->get['id']);		$this->assign('authMenu',$authMenu);	}	//授权	public function userAuth(){		if( empty($this->post['menuid']) || empty($this->post['id']) ){			Response::response( Response::ERROR );		}		//查询用户所属组的权限		$user = $this->module->getUserById( $this->post['id'] );		$groupGrants = $this->userGroupModule->getGroupAuth( $user['groupid'] );		//用户的权限不能大于所属组的权限		$diffGrants = array_diff( $this->post['menuid'], $groupGrants );		if( !empty($diffGrants) ){			Response::response( 10205 );		}		$data['auth'] = $this->post['menuid'];		if( !$this->module->updateUserAuth($data,$this->post['id']) ){			Response::response( Response::FAIL );		}		//更新当前session的权限		$data['ugrant'] = json_encode($data['auth']);		$this->setSession($data);		Response::response( Response::SUCCESS );	}	//用户登录	public function login(){ 		if( $this->checkLogin() ){			Common::toUrl('index');		}		if(!$this->post){			return false;		}		if($this->post['checkCode'] != $_SESSION['checkCode']){			Response::response( 10001 );		} 		$password = md5($this->post['password']);		if(!$user = $this->module->checkUser($this->post['uname'],$password)){			Response::response( 10002 );		}		if(!$user['status']){			Response::response( 10003 );		}		//设置session		$data['uid'] = $user['id'];		$data['groupid'] = $user['groupid'];		$data['uname'] = $user['uname'];		$data['ugrant'] = json_encode( $this->module->getUserGrants($user['id']) );		$this->setSession($data);		//记录操作		//$this->addActLog('login');				Response::response( Response::SUCCESS,10000 );	}	//用户退出	public function logout(){		//$this->addActLog('logout');		$this->desSession();		Common::toUrl('login');	}}